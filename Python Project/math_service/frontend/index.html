<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Service</title>
  <link rel="stylesheet" href="/frontend/style.css">
</head>
<body>
  <div class="container">
    <h1>Math Service</h1>

    <div class="section">
      <h2>Calculează Operații Matematice</h2>

      <label for="operation">Tip operație</label>
      <input id="operation" type="text" placeholder="pow, factorial sau fibonacci">

      <div id="inputFields">
        <label for="value">Prima valoare (x)</label>
        <input id="value" type="number" placeholder="Introduceți numărul">

        <!-- Câmp suplimentar pentru operația pow -->
        <div id="powFields" style="display: none;">
          <label for="valueY">A doua valoare (y) - pentru ridicarea la putere</label>
          <input id="valueY" type="number" placeholder="Puterea">
        </div>
      </div>

      <button id="submitBtn">Calculează și Salvează</button>

      <div id="logs">
        <h3>Rezultate</h3>
        <pre id="log_output">Rezultatele vor apărea aici...</pre>
      </div>

      <button class="secondary" onclick="window.location.href='/database'">
        Vizualizează Istoric Complet
      </button>
    </div>
  </div>

  <script>
    // Afișează/ascunde câmpuri în funcție de operație
    document.getElementById('operation').addEventListener('input', function() {
      const op = this.value.trim().toLowerCase();
      const powFields = document.getElementById('powFields');
      const valueLabel = document.querySelector('label[for="value"]');

      if (op === 'pow') {
        powFields.style.display = 'block';
        valueLabel.textContent = 'Prima valoare (x) - baza';
      } else {
        powFields.style.display = 'none';
        valueLabel.textContent = op === 'factorial' ? 'Numărul pentru factorial' :
                                op === 'fibonacci' ? 'Poziția în secvența Fibonacci' :
                                'Prima valoare (x)';
      }
    });

    document.getElementById('submitBtn').addEventListener('click', async () => {
      const op = document.getElementById('operation').value.trim().toLowerCase();
      const val = document.getElementById('value').value.trim();
      const valY = document.getElementById('valueY').value.trim();
      const logArea = document.getElementById('log_output');
      const submitBtn = document.getElementById('submitBtn');
      let payload = {};

      // Clear previous results and show loading
      logArea.textContent = `Procesez operația: ${op}...\n`;
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Se calculează...';

      // Validări
      if (!['pow', 'factorial', 'fibonacci'].includes(op)) {
        logArea.textContent += `Operație invalidă!\n`;
        logArea.textContent += `Operații disponibile: pow, factorial, fibonacci\n`;
        resetButton();
        return;
      }

      if (!val || isNaN(val)) {
        logArea.textContent += `Prima valoare trebuie să fie un număr valid!\n`;
        resetButton();
        return;
      }

      try {
        if (op === 'pow') {
          if (!valY || isNaN(valY)) {
            logArea.textContent += `Pentru operația pow, ambele valori (x și y) sunt necesare!\n`;
            resetButton();
            return;
          }
          payload = {
            x: parseFloat(val),
            y: parseFloat(valY)
          };
          logArea.textContent += `Calculez ${val}^${valY}...\n`;
        } else {
          const numVal = parseInt(val);
          if (numVal < 0) {
            logArea.textContent += `Pentru ${op}, valoarea trebuie să fie pozitivă!\n`;
            resetButton();
            return;
          }
          payload = { n: numVal };
          logArea.textContent += `Calculez ${op}(${numVal})...\n`;
        }

        const response = await fetch(`/api/${op}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
          logArea.textContent += `\nSUCCES!\n`;
          logArea.textContent += `Rezultat: ${formatResult(result, op)}\n`;
          logArea.textContent += `Salvat în baza de date\n`;
          logArea.textContent += `${new Date().toLocaleString()}\n`;

          // Highlight success
          logArea.style.border = '2px solid #059669';
          setTimeout(() => {
            logArea.style.border = '1px solid #e2e8f0';
          }, 3000);
        } else {
          logArea.textContent += `\nEROARE API!\n`;
          logArea.textContent += `${JSON.stringify(result, null, 2)}\n`;

          // Highlight error
          logArea.style.border = '2px solid #dc2626';
          setTimeout(() => {
            logArea.style.border = '1px solid #e2e8f0';
          }, 3000);
        }
      } catch (error) {
        logArea.textContent += `\nEROARE DE CONEXIUNE!\n`;
        logArea.textContent += `Nu s-a putut conecta la server\n`;
        logArea.textContent += `Detalii: ${error.message}\n`;

        // Highlight error
        logArea.style.border = '2px solid #dc2626';
        setTimeout(() => {
          logArea.style.border = '1px solid #e2e8f0';
        }, 3000);
      }

      resetButton();
    });

    function resetButton() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Calculează și Salvează';
    }

    function formatResult(result, operation) {
      switch(operation) {
        case 'pow':
          return `${result.x}^${result.y} = ${result.result}`;
        case 'factorial':
          return `${result.n}! = ${result.result}`;
        case 'fibonacci':
          return `fibonacci(${result.n}) = ${result.result}`;
        default:
          return JSON.stringify(result);
      }
    }

    // Enter key support
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('submitBtn').click();
      }
    });
  </script>
</body>
</html>